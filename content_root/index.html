<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="google-signin-scope" content="profile email">
    <meta name="google-signin-client_id" content="370606383019-jn3m29h3sq463rr42i3bv53v34vk4ups.apps.googleusercontent.com">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css"
          crossorigin="anonymous">
    <title>Title</title>
</head>
<body>
<div class="container">
    <h1>Auth Demo Sign-In</h1>
    <p>This demo uses Google Sign-In to provide verify a user's identity,
        and create a demo NATS account that can be used to access the demo websocket server.</p>

    <div id="google-signing-button"></div>
</div>

<script>
  function onSuccess (guser) {
    const id_token = guser.getAuthResponse().id_token
    const xhr = new XMLHttpRequest()
    xhr.open('POST', 'https://authdemo.nats-demo.info/api/token')
    xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded')
    xhr.onload = () => {
      if (xhr.status != 200) {
        console.log(xhr.statusText)
        alert('error authenticating - check the console')
        return
      }
      location.href = '/app.html'
    }
    xhr.onerror = (err) => {
      alert('request failed ' + err)
    }
    xhr.send('token=' + id_token)
  }

  function onFailure (error) {
    console.log(error)
    alert('Unable to log in - check the console')
  }

  function renderButton () {
    gapi.signin2.render('google-signing-button', {
      'scope': 'profile email',
      'width': 240,
      'height': 50,
      'longtitle': true,
      'theme': 'dark',
      'onsuccess': onSuccess,
      'onfailure': onFailure
    })
  }
</script>
<script src="https://apis.google.com/js/platform.js?onload=renderButton" async defer></script>
</body>
</html>